<!DOCTYPE html>
<html lang="uz" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upnex Call Center ‚Äî CRM Dashboard</title>
  <meta name="description" content="Upnex Call Center CRM: modern dashboard to log calls. Netlify Forms + Local backup + CSV export. No backend needed." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --brand:#0B5FFF; }
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card{ @apply rounded-2xl border border-slate-200 bg-white shadow-sm; }
    .input{ @apply w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[--brand]; }
    .btn{ @apply inline-flex items-center justify-center rounded-2xl px-4 py-2.5 font-semibold shadow hover:shadow-md transition active:scale-[.98]; }
    .btn-primary{ @apply text-white; background: linear-gradient(135deg,#0B5FFF,#367CFF); }
    .btn-ghost{ @apply bg-white/70 border border-slate-200; }
    .tag{ @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-medium bg-blue-50 text-blue-700; }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- Gradient Header -->
  <div class="relative isolate">
    <div class="absolute inset-0 -z-10 bg-gradient-to-r from-indigo-600 via-blue-600 to-sky-500"></div>
    <header class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3 text-white">
          <div class="h-11 w-11 rounded-2xl bg-white/20 grid place-items-center text-white font-black">U</div>
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Upnex Call Center</h1>
            <p class="text-white/80">Telefon qo‚Äòng‚Äòiroqlarini tez va toza log qilish</p>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-2">
          <button id="exportTop" class="btn btn-primary">‚¨áÔ∏è CSV yuklab olish</button>
        </div>
      </div>
    </header>
  </div>

  <!-- Shell: Sidebar + Main -->
  <div class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-[280px,1fr] gap-6">
    <!-- Sidebar -->
    <aside class="card p-4 lg:sticky lg:top-6 h-fit">
      <nav class="space-y-2">
        <a href="#new" class="btn btn-ghost w-full">‚ûï Yangi qo‚Äòng‚Äòiroq</a>
        <a href="#leads" class="btn btn-ghost w-full">üìã Ro‚Äòyxat</a>
        <button id="exportSide" class="btn btn-primary w-full">‚¨áÔ∏è CSV yuklab olish</button>
        <button id="clearLeads" class="btn btn-ghost w-full">üßπ Local backupni tozalash</button>
        <div class="pt-3 text-xs text-slate-500">We are Upnex, You are Next.</div>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="grid lg:grid-cols-2 gap-6">
      <!-- FORM COLUMN -->
      <section id="new" class="card p-6 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold">Yangi qo‚Äòng‚Äòiroq</h2>
          <span class="tag">Netlify Forms + Local Backup</span>
        </div>

        <!-- Netlify: data-netlify + hidden form-name required -->
        <form id="leadForm" name="call-center" method="POST" data-netlify="true" netlify-honeypot="bot-field" class="space-y-4">
          <input type="hidden" name="form-name" value="call-center" />
          <p class="hidden"><label>Don‚Äôt fill this out: <input name="bot-field" /></label></p>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">To‚Äòliq ism</label>
              <input class="input" type="text" name="full_name" id="full_name" placeholder="Masalan: Xayitbek Abdullaev" required />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Telefon raqam</label>
              <input class="input" type="tel" name="phone" id="phone" placeholder="+998 90 123 45 67" required />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Qo‚Äòng‚Äòiroq sababi</label>
              <select class="input" name="reason" id="reason" required>
                <option value="">Tanlang‚Ä¶</option>
                <option>USA ‚Äî Bakalavr</option>
                <option>USA ‚Äî Magistratura (TESL/TESOL/MBA‚Ä¶)</option>
                <option>Viza savollari (F‚Äë1, DS‚Äë160, I‚Äë20)</option>
                <option>Yevropa ‚Äî Universitet</option>
                <option>Malayziya/Singapur ‚Äî Universitet</option>
                <option>Schengen / boshqa</option>
                <option>Boshqa</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Manba (ixtiyoriy)</label>
              <select class="input" name="source" id="source">
                <option>Instagram</option>
                <option>Telegram</option>
                <option>Telefon</option>
                <option>Do‚Äòst tavsiyasi</option>
                <option>Boshqa</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Qisqa izoh</label>
            <textarea class="input min-h-[110px]" name="notes" id="notes" placeholder="Masalan: IELTS yo‚Äòq, Duolingo rejalashtirgan; budjet 2025; stipendiya muhim."></textarea>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Operator</label>
              <input class="input" type="text" name="agent" id="agent" placeholder="Kim qabul qildi?" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Follow‚Äëup kuni</label>
              <input class="input" type="date" name="follow_date" id="follow_date" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Status</label>
              <select class="input" name="status" id="status">
                <option>Yangi</option>
                <option>Qo‚Äòng‚Äòiroq qilindi</option>
                <option>Meeting belgilandi</option>
                <option>Hujjat bosqichi</option>
                <option>Yopildi (muvaffaqiyatli)</option>
                <option>Yopildi (rad etdi)</option>
              </select>
            </div>
          </div>

          <input type="hidden" name="submitted_at" id="submitted_at" />

          <div class="flex items-center gap-3">
            <input id="consent" type="checkbox" class="h-4 w-4" required />
            <label for="consent" class="text-sm text-slate-600">Shaxsiy ma‚Äôlumotlarni qayta ishlashga roziman</label>
          </div>

          <div class="flex flex-wrap items-center gap-3 pt-2">
            <button type="submit" class="btn btn-primary">Saqlash</button>
            <button type="button" id="resetForm" class="btn btn-ghost">Tozalash</button>
            <a href="#leads" class="btn btn-ghost">Ro‚Äòyxatga o‚Äòtish</a>
          </div>

          <p id="formMsg" class="text-sm text-emerald-600 hidden pt-2">Yuborildi ‚úÖ <span class="text-slate-500">(Netlify Forms va brauzer xotirasiga saqlandi)</span></p>
        </form>
      </section>

      <!-- LIST COLUMN -->
      <section id="leads" class="card p-6 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl md:text-2xl font-bold">So‚Äònggi leadlar (local backup)</h2>
          <div class="flex gap-2">
            <button id="exportCsv2" class="btn btn-primary">‚¨áÔ∏è CSV</button>
          </div>
        </div>

        <div class="mb-3 flex gap-2">
          <input id="search" class="input" placeholder="Qidirish: ism, telefon, sabab‚Ä¶" />
        </div>

        <div id="leadList" class="space-y-3 max-h-[600px] overflow-auto pr-1"></div>
        <p id="emptyState" class="text-slate-500">Hozircha ma‚Äôlumot yo‚Äòq.</p>
      </section>
    </main>
  </div>

  <footer class="text-center text-xs text-slate-500 pb-10">
    <p>¬© <span id="year"></span> Upnex. We are Upnex, You are Next.</p>
  </footer>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden">
    <div class="rounded-2xl bg-white shadow-lg border border-slate-200 px-4 py-3 text-slate-800">Yuborildi ‚úÖ</div>
  </div>

  <script>
    const $ = (q) => document.querySelector(q);
    const leadKey = 'upnex_leads_v1';

    function nowISO(){ return new Date().toISOString(); }
    function readLeads(){ try { return JSON.parse(localStorage.getItem(leadKey)||'[]'); } catch { return []; } }
    function writeLeads(arr){ localStorage.setItem(leadKey, JSON.stringify(arr)); }

    function toCSV(rows){
      if(!rows.length) return '';
      const header = Object.keys(rows[0]);
      const esc = (v)=> '"' + String(v??'').replace(/"/g,'""') + '"';
      const lines = [header.join(',')];
      rows.forEach(r=>lines.push(header.map(k=>esc(r[k])).join(',')));
      return lines.join('\n');
    }
    function download(filename, text){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'}));
      a.download=filename; a.click(); URL.revokeObjectURL(a.href);
    }

    function showToast(){
      const t = $('#toast'); t.classList.remove('hidden');
      t.animate([{opacity:0, transform:'translate(-50%, 12px)'},{opacity:1, transform:'translate(-50%, 0)'}],{duration:180, fill:'forwards'});
      setTimeout(()=>{ t.animate([{opacity:1},{opacity:0}],{duration:220, fill:'forwards'}).onfinish=()=>t.classList.add('hidden'); }, 1400);
    }

    function renderList(filter=''){
      const list=$('#leadList'); const empty=$('#emptyState'); list.innerHTML='';
      const q=filter.trim().toLowerCase();
      const data=readLeads().filter(x=>{ if(!q) return true; return [x.full_name,x.phone,x.reason,x.source,x.notes,x.status].some(v=>(v||'').toLowerCase().includes(q)); });
      if(!data.length){ empty.classList.remove('hidden'); return; } else { empty.classList.add('hidden'); }
      data.sort((a,b)=>(b.submitted_at||'').localeCompare(a.submitted_at||''));
      for(const item of data){
        const card=document.createElement('div');
        card.className='rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-4 shadow-sm';
        card.innerHTML=`
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-semibold text-slate-900">${item.full_name||''}</div>
              <div class="text-slate-600 text-sm">${item.phone||''}</div>
            </div>
            <span class="tag">${item.status||'Yangi'}</span>
          </div>
          <div class="mt-2 text-sm text-slate-700"><span class="font-medium">Sabab:</span> ${item.reason||''}</div>
          ${item.notes?`<div class="mt-1 text-sm text-slate-700"><span class="font-medium">Izoh:</span> ${item.notes}</div>`:''}
          <div class="mt-2 grid sm:grid-cols-3 gap-2 text-xs text-slate-500">
            <div><span class="font-medium">Manba:</span> ${item.source||'-'}</div>
            <div><span class="font-medium">Operator:</span> ${item.agent||'-'}</div>
            <div><span class="font-medium">Follow‚Äëup:</span> ${item.follow_date||'-'}</div>
          </div>
          <div class="mt-2 text-xs text-slate-500">Yuborilgan: ${new Date(item.submitted_at).toLocaleString()}</div>
        `;
        list.appendChild(card);
      }
    }

    $('#year').textContent=new Date().getFullYear();
    renderList();

    const exportFn=()=>{ const data=readLeads(); if(!data.length) return alert('Eksport qilish uchun ma‚Äôlumot yo‚Äòq.'); const csv=toCSV(data); const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); download(`upnex-callcenter-${stamp}.csv`, csv); };
    $('#exportTop').addEventListener('click', exportFn);
    $('#exportSide').addEventListener('click', exportFn);
    $('#exportCsv2').addEventListener('click', exportFn);

    $('#search').addEventListener('input', (e)=>renderList(e.target.value));
    $('#resetForm').addEventListener('click', ()=>{ $('#leadForm').reset(); $('#formMsg').classList.add('hidden'); });

    // AJAX submit to avoid 404 redirect
    document.querySelector('#leadForm').addEventListener('submit', function(e){
      e.preventDefault();
      const form=this;
      const phone=$('#phone').value.trim();
      const phoneOk=/^\+?\d[\d\s\-()]{7,}$/.test(phone);
      if(!phoneOk){ alert('Telefon raqamni to‚Äòg‚Äòri kiriting.'); return false; }
      $('#submitted_at').value=nowISO();

      const entry=Object.fromEntries(new FormData(form));
      const arr=readLeads(); arr.push(entry); writeLeads(arr); renderList($('#search').value);

      const data=new URLSearchParams(); Object.entries(entry).forEach(([k,v])=>data.append(k,v));
      data.set('form-name','call-center');

      fetch('/',{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:data.toString()})
        .then(()=>{ $('#formMsg').classList.remove('hidden'); showToast(); })
        .catch(()=>{ alert('Yuborishda muammo bo‚Äòldi, lekin local backup saqlandi. Keyinroq urinib ko‚Äòring.'); });
    });
  </script>

  <!--
    Deploy: root index.html, Netlify no build, publish dir "/".
    Make 1 test submission ‚Üí Netlify ‚Üí Forms ‚Üí call-center.
    Optional: Notifications, reCAPTCHA, Zapier/Make ‚Üí Google Sheets.
  -->
  <!-- Hidden form to make Netlify detect call-center -->
<form name="call-center" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="full_name" />
  <input type="tel"  name="phone" />
  <input type="text" name="reason" />
  <input type="text" name="source" />
  <input type="text" name="notes" />
  <input type="text" name="agent" />
  <input type="date" name="follow_date" />
  <input type="text" name="status" />
  <input type="text" name="submitted_at" />
</form>
</body>
</html>
